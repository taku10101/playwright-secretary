# freee会計統合ガイド

## 概要

Playwright秘書プラットフォームにfreee会計の自動ログイン機能を追加しました。
このドキュメントでは、freee統合の設定方法と使い方について説明します。

## 実装内容

### 1. アクションパターン定義

`.config/actions/freee/login.json` にfreee会計のログインアクションパターンを定義しました。

**含まれる処理:**
- freeeログインページへの遷移
- メールアドレスとパスワードの入力
- ログインボタンのクリック
- ログイン成功の検証

**パラメータ:**
- `email`: freeeアカウントのメールアドレス
- `password`: freeeアカウントのパスワード

### 2. ログインスクリプト

`scripts/freee-login.ts` にfreee会計へのログインを実行するスクリプトを作成しました。

**機能:**
- 環境変数から認証情報を読み込み
- Playwrightブラウザの起動と管理
- アクションパターンの実行
- 詳細なログとエラーハンドリング
- 実行結果の表示

### 3. npm スクリプト

`package.json` にfreeeログイン用のスクリプトを追加しました。

```json
{
  "scripts": {
    "freee:login": "tsx scripts/freee-login.ts"
  }
}
```

## セットアップ

### 1. 環境変数の設定

プロジェクトルートに `.env` ファイルを作成し、freee会計の認証情報を設定します。

```bash
NEXT_PUBLIC_FREEE_EMAIL=your_email@example.com
NEXT_PUBLIC_FREEE_PASSWORD=your_password
```

**セキュリティ注意:**
- `.env` ファイルは `.gitignore` に含まれているため、Gitにコミットされません
- 認証情報を安全に管理してください

### 2. 必要なパッケージのインストール

依存パッケージは既にインストール済みです：
- `playwright`: ブラウザ自動化
- `dotenv`: 環境変数の読み込み
- `tsx`: TypeScriptの直接実行

### 3. Playwrightブラウザのインストール

まだインストールしていない場合：

```bash
pnpm exec playwright install chromium
```

## 使い方

### コマンドラインから実行

```bash
pnpm freee:login
```

### 実行の流れ

1. 🚀 スクリプトが起動し、環境変数から認証情報を読み込み
2. 📋 アクションパターンを `.config/actions/freee/login.json` から読み込み
3. 🌐 Chromiumブラウザを起動（非ヘッドレスモード）
4. 🔄 ログインプロセスを実行：
   - freeeログインページへ遷移
   - メールアドレスを入力
   - パスワードを入力
   - ログインボタンをクリック
   - ページ遷移を待機
5. ✅ 結果を表示
6. ⏳ 5秒待機（結果確認用）
7. 🔒 ブラウザを閉じる

### 出力例（成功時）

```
🚀 freee会計へのログインを開始します...

📧 メールアドレス: your_email@example.com
🔒 パスワード: **********

✅ アクションパターンを読み込みました
   名前: freee会計ログイン
   ステップ数: 7

🌐 ブラウザを起動中...
✅ ブラウザを起動しました

🔄 ログイン処理を実行中...

============================================================
✅ ログインに成功しました！
   実行時間: 8.45秒
   完了ステップ: 7/7
   スクリーンショット: 7枚保存
============================================================

⏳ 5秒後にブラウザを閉じます...
✅ ブラウザを閉じました
```

### 出力例（失敗時）

```
🚀 freee会計へのログインを開始します...

❌ エラー: 環境変数が設定されていません
   NEXT_PUBLIC_FREEE_EMAIL と NEXT_PUBLIC_FREEE_PASSWORD を .env ファイルに設定してください
```

または

```
============================================================
❌ ログインに失敗しました
   エラー: Timeout 30000ms exceeded
   実行時間: 30.12秒

失敗したステップ:
   - Step 2: メールアドレス入力フィールドを待機
     エラー: Timeout 30000ms exceeded
============================================================
```

## アクションパターンの詳細

### ステップ構成

1. **navigate**: freeeログインページへ遷移
2. **waitForSelector**: メールアドレス入力フィールドを待機
3. **fill**: メールアドレスを入力
4. **fill**: パスワードを入力
5. **click**: ログインボタンをクリック
6. **waitForNavigation**: ログイン後のページ遷移を待機
7. **wait**: ページの完全な読み込みを待機（オプショナル）

### バリデーション

ログイン成功を確認するため、以下の検証を実行：
- URLに `secure.freee.co.jp` が含まれているか

### カスタマイズ

`.config/actions/freee/login.json` を編集することで、以下をカスタマイズ可能：
- タイムアウト時間
- セレクター（freeeのUIが変更された場合）
- 検証ルール
- リトライ回数

## トラブルシューティング

### 環境変数が読み込まれない

- `.env` ファイルがプロジェクトルートに存在することを確認
- ファイル名が `.env` であることを確認（`.env.exsample` ではない）
- 環境変数名が正しいことを確認

### ブラウザが起動しない

```bash
pnpm exec playwright install chromium
```

### セレクターが見つからない

freeeのUIが変更された可能性があります。以下を確認：
1. freeeにブラウザでアクセスし、開発者ツールでセレクターを確認
2. `.config/actions/freee/login.json` のセレクターを更新

### タイムアウトエラー

ネットワークが遅い場合、タイムアウト時間を増やします：

`.config/actions/freee/login.json` で各ステップの `timeout` を調整。

## 今後の拡張

### 追加予定の機能

1. **多要素認証（MFA）対応**
   - SMS認証コードの入力
   - 認証アプリの統合

2. **追加アクション**
   - 仕訳の作成
   - 請求書の発行
   - レポートのダウンロード

3. **MCP Server統合**
   - Claude Codeから自然言語でfreee操作
   - タスクスケジューリング

### アクションパターンの追加方法

新しいfreeeアクションを追加する場合：

1. `.config/actions/freee/` に新しいJSONファイルを作成
2. ActionPatternスキーマに従ってアクションを定義
3. 必要に応じて専用スクリプトを作成

例：`create-invoice.json` （請求書作成）

## セキュリティ

### 認証情報の管理

- 環境変数は `.env` ファイルに保存
- `.env` はGitから除外されている（`.gitignore`）
- 本番環境では環境変数を安全に管理（AWS Secrets Manager等）

### ベストプラクティス

- 開発環境専用のfreeeアカウントを使用
- 定期的にパスワードを変更
- アクセスログを確認
- 必要最小限の権限のみを使用

## ライセンス

MIT

## サポート

問題が発生した場合：
1. このドキュメントのトラブルシューティングを確認
2. GitHubでIssueを作成
3. ログファイルを添付して報告
