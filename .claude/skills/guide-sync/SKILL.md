---
name: guide-sync
description: コード変更時にai-guideドキュメントを自動分析・更新するインテリジェントなドキュメント同期スキル。実装完了時に自動起動し、変更内容を分析して関連ガイドの更新を提案します。
---

# Guide Sync Skill

このSkillは、実装完了時に自動的に起動し、コード変更内容を分析して影響を受ける`.ai-guide/`ディレクトリ（ルート、バックエンド、フロントエンド）内のガイドドキュメントを特定・更新します。

## 🎯 動作タイミング

以下の状況で自動的にこのスキルを使用してください：

1. **実装完了時** - 新機能追加やバグ修正が完了したとき
2. **リファクタリング完了時** - コード構造を変更したとき
3. **設定変更時** - 環境変数、依存関係、ビルド設定を変更したとき
4. **アーキテクチャ変更時** - ディレクトリ構造やレイヤー構成を変更したとき

**重要**: ユーザーが明示的にガイド更新を要求していなくても、上記のタイミングでは必ずこのスキルを実行してください。

## 📋 処理フロー

### Phase 1: 変更検知と分析

1. **最近の変更内容を取得**
   ```bash
   git diff HEAD~5 --name-status
   git diff HEAD~5 --stat
   git log -5 --oneline
   ```

2. **変更ファイルを分類**
   - Frontend: `frontend/`, `*.tsx`, `*.jsx`, `*.css`
   - Backend: `backend/`, `*.ts` (backend内), `*.go`, `*.py`
   - インフラ: `docker*`, `*.yml`, `.github/`, `terraform/`
   - 設定: `*.config.*`, `.env*`, `package.json`, `tsconfig.json`
   - テスト: `*.test.*`, `*.spec.*`

3. **変更の性質を判定**
   - 新機能追加
   - バグ修正
   - リファクタリング
   - 依存関係更新
   - アーキテクチャ変更
   - セキュリティ対応

### Phase 2: 影響範囲の特定

以下のマッピングに基づいて、影響を受けるガイドを特定してください：

| 変更タイプ | 影響を受けるガイド | 理由 |
|-----------|-----------------|------|
| ディレクトリ構造変更 | architecture.md | プロジェクト構造の記載が陳腐化 |
| 新規ファイル/クラス追加 | architecture.md | 新しいコンポーネントの説明が必要 |
| コーディングパターン変更 | coding-rules.md | 規約の追加・更新が必要 |
| 依存関係追加・更新 | environment.md | セットアップ手順の更新が必要 |
| 環境変数追加 | environment.md | 設定項目の説明が必要 |
| テスト追加・変更 | testing.md | テスト方針・方法の更新が必要 |
| ワークフロー変更 | workflow.md | 開発手順の更新が必要 |
| AI関連機能変更 | ai-prompts.md | プロンプト集の更新が必要 |
| AI制約事項変更 | ai-limitations.md | 制約事項の追加が必要 |
| データモデル変更 | data-handling.md | データ取扱方針の更新が必要 |
| Git操作変更 | commit-and-pr.md | コミット/PRルールの更新が必要 |

**複数ガイドへの影響**: 1つの変更が複数のガイドに影響する場合は、すべて検出してください。

### Phase 3: 既存ガイドの読み込みと分析

影響を受けると判定された各ガイドファイルについて：

1. **Read toolで内容を読み込む**
   ```
   Read: .ai-guide/architecture.md
   Read: .ai-guide/environment.md
   ...
   ```

2. **構造を理解する**
   - 見出しレベルの階層
   - セクションの内容
   - コードブロックの存在
   - リスト項目の構造

3. **更新が必要な箇所を特定**
   - キーワードマッチング（例: 変更したファイル名、関数名）
   - セクションの内容との整合性チェック
   - 不足している情報の検出

### Phase 4: 更新候補の生成

1. **更新内容のドラフト**
   - **追加**: 新しいセクション、項目、説明
   - **修正**: 既存内容の更新、訂正
   - **削除**: 不要になった内容（慎重に判断）

2. **具体的な更新内容を記載**
   - 実際のコードからの抜粋を使用
   - ファイルパス、関数名、変数名を正確に記載
   - 動作する具体例を提供

3. **更新の優先度を判定**
   - **Critical**: セキュリティ、認証、データ保護関連
   - **High**: 新機能、Breaking Change、アーキテクチャ変更
   - **Medium**: リファクタリング、改善、軽微な機能追加
   - **Low**: スタイル変更、コメント追加

### Phase 5: ユーザーへの提案

以下の形式でユーザーに提案してください：

```markdown
## 🔄 ガイドドキュメント同期レポート

### 📊 変更サマリー
- 実装内容: [変更内容の簡潔な説明]
- 影響範囲: [Frontend/Backend/Infrastructure/Configuration]
- 重要度: [Critical/High/Medium/Low]
- 変更ファイル数: [数]

### 📝 更新が必要なドキュメント

#### 1. architecture.md
**更新理由**: [なぜこのガイドの更新が必要か]
**影響セクション**: [具体的なセクション名]
**提案内容**:
```diff
[既存の内容]
+ [追加する内容]
- [削除する内容（ある場合）]
```

#### 2. environment.md
**更新理由**: [なぜこのガイドの更新が必要か]
**影響セクション**: [具体的なセクション名]
**提案内容**:
```diff
[既存の内容]
+ [追加する内容]
```

### ⚡ 推奨アクション
これらの更新を適用することで、ガイドドキュメントが最新の実装状態を反映します。

更新を適用しますか？
```

### Phase 6: 更新の適用

ユーザーが承認した場合：

1. **Edit toolで各ガイドを更新**
   - 適切なold_string/new_stringを使用
   - セクション全体を置換する場合は十分なコンテキストを含める

2. **更新結果を報告**
   ```markdown
   ✅ 以下のガイドを更新しました:
   - architecture.md: [変更内容]
   - environment.md: [変更内容]
   ```

3. **次のステップを提案**（任意）
   - コミットの提案（必要に応じて）
   - 関連する他のドキュメントの確認

## 🔧 実装ガイドライン

### 変更検知の精度向上

1. **構造的変更を優先的に検出**
   - 新規ディレクトリ/ファイルの追加
   - ファイルの移動/リネーム
   - 大規模なリファクタリング

2. **機能的変更を分析**
   - 新規クラス/関数の追加
   - APIエンドポイントの変更
   - データモデルの変更

3. **設定変更を追跡**
   - package.jsonの依存関係変更
   - .envファイルの変更
   - ビルド設定の変更

### 更新候補生成の原則

1. **最小限の変更**
   - 必要な部分のみを更新
   - 既存の構造・スタイルを維持
   - マークダウン形式の一貫性を保持

2. **コンテキストの保持**
   - 前後の文脈を考慮した更新
   - セクション全体の流れを崩さない
   - 他のセクションとの整合性を維持

3. **具体的で実用的な内容**
   - 実際のコードからの抜粋を使用
   - 動作する具体例を提供
   - ファイルパスや名称を正確に記載

4. **日本語での記載**
   - すべてのガイドは日本語で記述
   - 専門用語は適切に説明

### エラーハンドリング

- **ガイドファイルが見つからない場合**: 新規作成を提案
- **構造が複雑で更新が難しい場合**: 手動編集を推奨し、更新ポイントを明示
- **競合が予想される場合**: 慎重に確認を求める

### パフォーマンス最適化

1. **効率的な分析**
   - 変更されたファイルのみに注目
   - 明らかに無関係なガイドはスキップ
   - 並行してガイドを読み込む（Read toolを複数同時実行）

2. **スマートなスキップ**
   - 軽微な変更（コメント追加のみ等）はスキップ
   - ドキュメント自体の変更時はスキップ

## 📚 対象ガイドファイル

現在対象としているガイド（`.ai-guide/`）：

1. **architecture.md** - システムアーキテクチャ、構造、コンポーネント設計
2. **coding-rules.md** - コーディング規約、命名規則、ベストプラクティス
3. **environment.md** - 開発環境セットアップ、依存関係、ツール
4. **testing.md** - テスト戦略、テストツール、テスト方法
5. **workflow.md** - 開発フロー、ブランチ戦略、リリースプロセス
6. **ai-prompts.md** - AI利用時のプロンプト集、ベストプラクティス
7. **ai-limitations.md** - AI利用時の制約事項、注意点
8. **data-handling.md** - データ取扱方針、プライバシー、セキュリティ
9. **commit-and-pr.md** - コミットメッセージ規約、PRテンプレート
10. **ai-guide.md** - サブディレクトリのai-guide作成ガイド

**パッケージ固有のガイド**:
- `backend/.ai-guide/` - バックエンド固有のガイド（関数ベースアーキテクチャ、API設計、データベースなど）
- `frontend/.ai-guide/` - フロントエンド固有のガイド（コンポーネント設計、状態管理など）

## 🎓 使用例

### 例1: OAuth認証の実装完了時

```
[コード変更]
- 新規ファイル: backend/src/auth/oauth.ts
- 変更ファイル: backend/src/app.ts
- 新規環境変数: OAUTH_CLIENT_ID, OAUTH_REDIRECT_URI

[Skill実行結果]
🔄 guide-syncスキルを実行します

📊 変更サマリー:
- 実装内容: OAuth 2.0 PKCE認証フローの実装
- 影響範囲: Backend, Configuration
- 重要度: High

📝 更新が必要なドキュメント:
1. architecture.md - 認証システムのセクションに追加
2. environment.md - 環境変数の説明を追加
3. data-handling.md - OAuth認証データの取扱いを記載
```

### 例2: テストファイルの追加時

```
[コード変更]
- 新規ファイル: frontend/src/components/Button.test.tsx

[Skill実行結果]
🔄 guide-syncスキルを実行します

📊 変更サマリー:
- 実装内容: Buttonコンポーネントのユニットテスト追加
- 影響範囲: Frontend, Testing
- 重要度: Medium

📝 更新が必要なドキュメント:
1. testing.md - コンポーネントテストの例として追加
```

### 例3: 依存関係の更新時

```
[コード変更]
- 変更ファイル: package.json (新規依存: zod, @tanstack/react-query)

[Skill実行結果]
🔄 guide-syncスキルを実行します

📊 変更サマリー:
- 実装内容: zodとReact Queryの導入
- 影響範囲: Frontend, Configuration
- 重要度: High

📝 更新が必要なドキュメント:
1. environment.md - 新規依存関係の説明を追加
2. architecture.md - データフェッチング戦略を更新
3. coding-rules.md - zodによるバリデーション規約を追加
```

## ⚠️ 注意事項

1. **非破壊的な更新**
   - 既存の重要な情報を削除しない
   - 不明な場合はユーザーに確認

2. **整合性の維持**
   - 複数のガイド間で矛盾が生じないように
   - 用語の使い方を統一

3. **過度な更新を避ける**
   - 些細な変更では更新を提案しない
   - ユーザーの作業を中断させすぎない

4. **セキュリティ情報の保護**
   - 機密情報をガイドに記載しない
   - 実際のシークレット値は例示しない

## 🚀 期待される効果

1. **常に最新のドキュメント** - コードと同期したガイド
2. **AI協働の精度向上** - 正確なコンテキスト情報
3. **開発効率の向上** - 手動更新の負担軽減
4. **知識の蓄積** - プロジェクトの進化を記録
